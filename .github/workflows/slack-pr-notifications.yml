name: Slack PR Notifications

on:
  pull_request:
    types: [opened, closed, reopened, synchronize]

jobs:
  notify-slack:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Prepare PR Opened Payload
        if: github.event.action == 'opened'
        id: pr-opened
        run: |
          PR_TITLE=$(echo '${{ toJson(github.event.pull_request.title) }}' | sed 's/^"//;s/"$//')
          PR_BODY=$(echo '${{ toJson(github.event.pull_request.body || 'No description provided') }}' | sed 's/^"//;s/"$//')
          PR_AUTHOR='${{ github.event.pull_request.user.login }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          BASE_REF='${{ github.event.pull_request.base.ref }}'
          HEAD_REF='${{ github.event.pull_request.head.ref }}'
          ADDITIONS='${{ github.event.pull_request.additions }}'
          DELETIONS='${{ github.event.pull_request.deletions }}'
          
          PAYLOAD=$(jq -n \
            --arg title "$PR_TITLE" \
            --arg body "$PR_BODY" \
            --arg author "$PR_AUTHOR" \
            --arg url "$PR_URL" \
            --arg base "$BASE_REF" \
            --arg head "$HEAD_REF" \
            --arg additions "$ADDITIONS" \
            --arg deletions "$DELETIONS" \
            '{
              "text": "üîµ New Pull Request",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üîµ New Pull Request"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n\($author)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Title:*\n<\($url)|\($title)>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Base ‚Üí Head:*\n`\($base)` ‚Üí `\($head)`"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Description:*\n\($body)"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üìä *\($additions)* additions, *\($deletions)* deletions"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View PR"
                      },
                      "url": $url
                    }
                  ]
                }
              ]
            }')
          
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Slack on PR Opened
        if: github.event.action == 'opened'
        uses: slackapi/slack-github-action@v1.27.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: ${{ steps.pr-opened.outputs.payload }}

      - name: Prepare PR Merged Payload
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        id: pr-merged
        run: |
          PR_TITLE=$(echo '${{ toJson(github.event.pull_request.title) }}' | sed 's/^"//;s/"$//')
          PR_AUTHOR='${{ github.event.pull_request.user.login }}'
          PR_MERGED_BY='${{ github.event.pull_request.merged_by.login }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          BASE_REF='${{ github.event.pull_request.base.ref }}'
          ADDITIONS='${{ github.event.pull_request.additions }}'
          DELETIONS='${{ github.event.pull_request.deletions }}'
          MERGE_COMMIT='${{ github.event.pull_request.merge_commit_sha }}'
          REPO='${{ github.repository }}'
          
          if [ -n "$MERGE_COMMIT" ]; then
            COMMIT_URL="https://github.com/$REPO/commit/$MERGE_COMMIT"
          else
            COMMIT_URL="$PR_URL"
          fi
          
          PAYLOAD=$(jq -n \
            --arg title "$PR_TITLE" \
            --arg author "$PR_AUTHOR" \
            --arg merged_by "$PR_MERGED_BY" \
            --arg url "$PR_URL" \
            --arg base "$BASE_REF" \
            --arg additions "$ADDITIONS" \
            --arg deletions "$DELETIONS" \
            --arg commit_url "$COMMIT_URL" \
            '{
              "text": "‚úÖ Pull Request Merged",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Pull Request Merged"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n\($author)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Title:*\n<\($url)|\($title)>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Merged by:*\n\($merged_by)"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "üìä *\($additions)* additions, *\($deletions)* deletions ‚Ä¢ Merged into `\($base)`"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View PR"
                      },
                      "url": $url
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Commit"
                      },
                      "url": $commit_url
                    }
                  ]
                }
              ]
            }')
          
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Slack on PR Merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        uses: slackapi/slack-github-action@v1.27.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: ${{ steps.pr-merged.outputs.payload }}

      - name: Prepare PR Closed Payload
        if: github.event.action == 'closed' && github.event.pull_request.merged == false
        id: pr-closed
        run: |
          PR_TITLE=$(echo '${{ toJson(github.event.pull_request.title) }}' | sed 's/^"//;s/"$//')
          PR_AUTHOR='${{ github.event.pull_request.user.login }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          
          PAYLOAD=$(jq -n \
            --arg title "$PR_TITLE" \
            --arg author "$PR_AUTHOR" \
            --arg url "$PR_URL" \
            '{
              "text": "‚ùå Pull Request Closed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå Pull Request Closed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Author:*\n\($author)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Title:*\n<\($url)|\($title)>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View PR"
                      },
                      "url": $url
                    }
                  ]
                }
              ]
            }')
          
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Slack on PR Closed (Not Merged)
        if: github.event.action == 'closed' && github.event.pull_request.merged == false
        uses: slackapi/slack-github-action@v1.27.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: ${{ steps.pr-closed.outputs.payload }}
