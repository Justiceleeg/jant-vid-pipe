# Context Handoff Document

## Current Situation
Tom built a Firestore/Firebase backend on branch `tom-backend` while 3 teammates changed main. Branch is 7 commits ahead with 77 files changed (+15,566 lines). Architecture is 70% working but has critical integration gaps.

## Key Discoveries

### 1. CRITICAL BUG: Scenes Never Initialize
- TWO competing systems exist: legacy storyboard + new project system
- NEITHER is called - users see empty scenes page
- Fix: Add auto-initialization in `frontend/app/project/[id]/scenes/page.tsx`

### 2. Store Architecture
- **appStore**: Current working state (has everything)
- **projectStore**: Syncs appStore â†’ backend (missing some fields)
- **firestoreProjectStore**: Unused real-time alternative

### 3. Missing Integrations
- Backgrounds/characters/brands selected but not saved to backend
- Scene regenerate endpoints are stubs
- Audio still uses temp URLs (not Firebase)

## Implementation Plan (Phase Summary)

### Phase 1: Critical Fixes (45 min) 
```
1A. Fix scene init â†’ add auto-init when empty
1B. Add missing endpoints â†’ regenerate text/image
1C. State persistence â†’ Option 3: Store ENTIRE appStore as JSON blob
```

### Phase 2: Deploy & Test (30 min)
```
Deploy Firebase rules/functions â†’ Start services â†’ Smoke test full flow
```

### Phase 3: Clean Up (30 min)
```
Delete storyboard system â†’ Move OpenAI logic to project service
```

### Phase 4: Polish (30 min)
```
Fix audio storage â†’ Verify all assets â†’ Firebase
```

## Key Files & Status

### Frontend
- âœ… `frontend/app/project/[id]/mood/page.tsx` - Working, saves to Firebase
- ðŸ”§ `frontend/app/project/[id]/scenes/page.tsx` - NEEDS scene init added
- ðŸ”§ `frontend/hooks/useProjectScenes.ts` - Has stub functions
- âŒ `frontend/hooks/useStoryboard.ts` - DELETE THIS
- ðŸ”§ `frontend/store/projectStore.ts` - Needs app_state_snapshot

### Backend  
- âœ… `backend/app/routers/projects.py` - Has endpoints, needs 2 more
- âœ… `backend/app/models/project_models.py` - Needs app_state field
- âŒ `backend/app/routers/storyboards.py` - DELETE THIS
- ðŸ”§ `backend/app/services/storyboard_service.py` - Extract OpenAI logic then DELETE

## Critical Decisions Made
1. **Use project system only** - Delete storyboard system entirely
2. **Move OpenAI logic** - Don't keep calling storyboard service  
3. **State persistence: Option 3** - Store entire appStore as JSON (solves drift permanently)
4. **Everything must work** - Full demo ready
5. **Future: Option 2** - Proper asset management after demo ships

## Next Agent Instructions

### Immediate Next Steps
1. **Start with Phase 1A**: Add scene initialization to scenes page
   ```typescript
   // In frontend/app/project/[id]/scenes/page.tsx
   useEffect(() => {
     if (!isLoading && project && scenes.length === 0) {
       projectsApi.initializeScenes(projectId);
     }
   }, [project, scenes, isLoading]);
   ```

2. **Then Phase 1B**: Add missing endpoints in `backend/app/routers/projects.py`
   - `/regenerate-text` 
   - `/regenerate-image`

3. **Then Phase 1C**: Add `app_state_snapshot` to capture all UI state

### What to Read First
1. `salvage_plan/implementation-phases.md` - The full plan
2. `salvage_plan/04-storyboard-project-overlap.md` - Critical issue explanation
3. `salvage_plan/03-working-vs-broken.md` - Current status

### Testing Checklist
- [ ] Project creation works
- [ ] Mood generation saves images to Firebase  
- [ ] Backgrounds selection persists
- [ ] **Scenes auto-initialize when empty**
- [ ] Scene text editing works
- [ ] Image generation works
- [ ] Video generation works  
- [ ] State persists on refresh

### Key Context
- This is a DEMO, no real users
- Can delete data anytime
- Team of 4 working without coordination
- Tom's branch has good architecture but incomplete integration
- Main issue is coordination, not code quality

## Branch Info
- Branch: `tom-backend`
- Status: Merged latest from main
- Conflicts: Resolved
- Ready: Yes, just needs fixes above

## Contact
Tom is the branch owner. Architecture questions should reference the salvage_plan/ directory.

---
*Generated by previous agent. Start with Phase 1A in implementation-phases.md*
